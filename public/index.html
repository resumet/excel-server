<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel File Center</title>
  <link rel="stylesheet" type="text/css" href="/styles.css" />
</head>
<body>
  <main class="page">
    <section class="card">
      <div class="card__header">
        <div>
          <p class="eyebrow">Excel File Center</p>
          <h1>엑셀 파일 업로드</h1>
          <p class="sub">Firebase Hosting + Functions + Storage로 동작하는 버전입니다.</p>
        </div>
        <form class="upload" id="uploadForm">
          <label class="file">
            <input type="file" name="excel" accept=".xls,.xlsx,.xlsm,.xlsb" required />
            <span>파일 선택</span>
          </label>
          <button class="btn primary" type="submit">업로드</button>
        </form>
      </div>

      <div class="alert" id="alert" hidden></div>

      <div class="table">
        <div class="table__head">
          <div>파일명</div>
          <div>용량</div>
          <div>업데이트</div>
          <div class="align-right">작업</div>
        </div>
        <div class="table__body" id="tableBody"></div>
      </div>
    </section>
  </main>

  <script>
    const tableBody = document.getElementById('tableBody');
    const alertBox = document.getElementById('alert');
    const uploadForm = document.getElementById('uploadForm');

    const showAlert = (message) => {
      alertBox.textContent = message;
      alertBox.hidden = false;
    };

    const hideAlert = () => {
      alertBox.hidden = true;
    };

    const formatBytes = (bytes) => {
      if (!bytes) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB'];
      const index = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
      return `${(bytes / (1024 ** index)).toFixed(index === 0 ? 0 : 1)} ${units[index]}`;
    };

    const renderEmpty = () => {
      tableBody.innerHTML = '<div class="table__empty">업로드된 파일이 없습니다.</div>';
    };

    const renderFiles = (files) => {
      if (!files || files.length === 0) {
        renderEmpty();
        return;
      }
      tableBody.innerHTML = files.map((file) => {
        const updated = file.updated ? new Date(file.updated).toLocaleString() : '-';
        return `
          <div class="table__row" data-name="${file.name}">
            <div class="file-name">${file.name}</div>
            <div class="meta">${formatBytes(file.size)}</div>
            <div class="meta">${updated}</div>
            <div class="actions">
              <a class="btn ghost" href="/api/files/${encodeURIComponent(file.name)}/download">다운로드</a>
              <button class="btn danger" type="button" data-action="delete" data-name="${file.name}">삭제</button>
            </div>
          </div>
        `;
      }).join('');
    };

    const fetchFiles = async () => {
      const response = await fetch('/api/files');
      if (!response.ok) throw new Error('목록을 가져오지 못했습니다.');
      const payload = await response.json();
      renderFiles(payload.files || []);
    };

    uploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      hideAlert();
      const formData = new FormData(uploadForm);
      try {
        const response = await fetch('/api/upload', { method: 'POST', body: formData });
        if (!response.ok) {
          const payload = await response.json().catch(() => ({}));
          throw new Error(payload.message || '업로드에 실패했습니다.');
        }
        uploadForm.reset();
        await fetchFiles();
      } catch (err) {
        showAlert(err.message || '업로드에 실패했습니다.');
      }
    });

    document.addEventListener('click', async (event) => {
      const button = event.target.closest('button[data-action="delete"]');
      if (!button) return;
      const name = button.dataset.name;
      if (!confirm(`"${name}" 파일을 삭제할까요?`)) return;
      try {
        const response = await fetch(`/api/files/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if (!response.ok) {
          const payload = await response.json().catch(() => ({}));
          throw new Error(payload.message || '삭제에 실패했습니다.');
        }
        await fetchFiles();
      } catch (err) {
        showAlert(err.message || '삭제에 실패했습니다.');
      }
    });

    fetchFiles().catch((err) => {
      showAlert(err.message || '데이터를 불러오지 못했습니다.');
      renderEmpty();
    });
  </script>
</body>
</html>
